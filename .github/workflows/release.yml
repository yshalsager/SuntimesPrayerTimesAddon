name: Release

on:
  workflow_dispatch:
    inputs:
      create_tag:
        description: 'Create and push a release tag'
        required: true
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (skip GitHub Release)'
        required: true
        default: true
        type: boolean
      release:
        description: 'Bump version from last tag and create a release'
        required: true
        default: false
        type: boolean
      bump:
        description: 'Semver bump type (used when release=true)'
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: 'Optional explicit version (e.g. 0.2.0). Overrides bump calculation when set.'
        required: false
        type: string
  push:
    tags:
      - 'v*.*.*'

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.v.outputs.version }}
      tag: ${{ steps.v.outputs.tag }}
      checkout_ref: ${{ steps.checkout_ref.outputs.ref }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.RELEASE_TOKEN || github.token }}

      - uses: jdx/mise-action@v3
        with:
          cache: true
          cache_key_prefix: 'mise-v1'
          # AGP 9.x is built/tested with JDK 17. Keep repo's mise.toml untouched; override Java in CI only.
          mise_toml: |
            [tools]
            java = "temurin-17.0.18+8"

      - name: Compute version
        id: v
        shell: bash
        run: |
          set -euo pipefail

          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ inputs.release }}" != "true" ]]; then
            VERSION="$(sed -nE "s/^[[:space:]]*versionName[[:space:]]+['\"]([^'\"]+)['\"].*$/\\1/p" app/build.gradle | head -n 1)"
            if [[ -z "$VERSION" ]]; then
              echo "versionName not found in app/build.gradle"
              exit 1
            fi
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LAST_TAG=$(git tag -l 'v*.*.*' --sort=-v:refname | head -n 1 || true)
          if [[ -z "$LAST_TAG" ]]; then
            BASE="0.1.0"
          else
            BASE="${LAST_TAG#v}"
          fi

          IFS='.' read -r major minor patch <<<"$BASE"
          case "${{ inputs.bump }}" in
            major) major=$((major+1)); minor=0; patch=0 ;;
            minor) minor=$((minor+1)); patch=0 ;;
            patch) patch=$((patch+1)) ;;
          esac

          VERSION="$major.$minor.$patch"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

      - name: Bump version files (manual release)
        if: ${{ inputs.release && inputs.create_tag && github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/') }}
        env:
          VERSION: ${{ steps.v.outputs.version }}
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import os, re
          from pathlib import Path

          version = os.environ['VERSION']
          p = Path("app/build.gradle")
          s = p.read_text()

          m = re.search(r"versionCode\s+(\d+)", s)
          if not m:
            raise SystemExit("versionCode not found in app/build.gradle")
          next_code = int(m.group(1)) + 1

          s = re.sub(r"versionCode\s+\d+", f"versionCode {next_code}", s, count=1)
          s = re.sub(r"versionName\s+['\"][^'\"]+['\"]", f"versionName '{version}'", s, count=1)
          p.write_text(s)
          print(f"versionName={version} versionCode={next_code}")
          PY

      - name: Commit + tag (manual release)
        if: ${{ inputs.release && inputs.create_tag && github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/') }}
        env:
          TAG: ${{ steps.v.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add app/build.gradle
          git commit -m "chore(release): $TAG"
          git tag "$TAG"

      - name: Push changes (manual release)
        if: ${{ inputs.release && inputs.create_tag && github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/') }}
        shell: bash
        run: |
          set -euo pipefail
          git push
          git push --tags

      - name: Decide checkout ref
        id: checkout_ref
        env:
          TAG: ${{ steps.v.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          REF="$GITHUB_REF"
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            REF="$GITHUB_REF"
          elif [[ "${{ inputs.release }}" == "true" && "${{ inputs.create_tag }}" == "true" ]]; then
            REF="refs/tags/$TAG"
          fi
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

  build:
    needs: version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ needs.version.outputs.checkout_ref }}

      - uses: android-actions/setup-android@v3
        with:
          packages: 'platform-tools platforms;android-35 build-tools;35.0.0'

      - uses: jdx/mise-action@v3
        with:
          cache: true
          cache_key_prefix: 'mise-v1'
          mise_toml: |
            [tools]
            java = "temurin-17.0.18+8"

      - uses: gradle/actions/setup-gradle@v4

      - name: Decode signing keystore
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          if [[ -z "${ANDROID_KEYSTORE_BASE64:-}" ]]; then
            echo "Missing secret ANDROID_KEYSTORE_BASE64"
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > release-keystore.jks
          ls -la release-keystore.jks

      - name: Build APKs
        shell: bash
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [[ -z "${ANDROID_KEYSTORE_PASSWORD:-}" || -z "${ANDROID_KEY_ALIAS:-}" || -z "${ANDROID_KEY_PASSWORD:-}" ]]; then
            echo "Missing signing secrets: ANDROID_KEYSTORE_PASSWORD / ANDROID_KEY_ALIAS / ANDROID_KEY_PASSWORD"
            exit 1
          fi

          mise x java -- ./gradlew :app:assembleDebug
          mise x java -- ./gradlew :app:assembleRelease \
            -Pandroid.injected.signing.store.file="$PWD/release-keystore.jks" \
            -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$ANDROID_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$ANDROID_KEY_PASSWORD"

      - name: Collect artifacts
        id: artifacts
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.version.outputs.version }}"

          DEBUG_APK=$(find app/build/outputs/apk/debug -type f -name "*.apk" | head -n 1 || true)
          RELEASE_APK=$(find app/build/outputs/apk/release -type f -name "*.apk" | head -n 1 || true)

          if [[ -z "$DEBUG_APK" ]]; then
            echo "No debug APK found"
            exit 1
          fi

          if [[ -z "$RELEASE_APK" ]]; then
            echo "No release APK found"
            exit 1
          fi

          OUT_DEBUG="PrayerTimesAddon-v$VERSION-debug.apk"
          OUT_RELEASE="PrayerTimesAddon-v$VERSION-release.apk"
          cp "$DEBUG_APK" "$OUT_DEBUG"
          cp "$RELEASE_APK" "$OUT_RELEASE"

          echo "apk_debug=$OUT_DEBUG" >> "$GITHUB_OUTPUT"
          echo "apk_release=$OUT_RELEASE" >> "$GITHUB_OUTPUT"
          echo "Debug APK: $OUT_DEBUG"
          echo "Release APK: $OUT_RELEASE"

      - name: Verify release APK signature
        shell: bash
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          if [[ -z "$SDK_ROOT" ]]; then
            echo "ANDROID_SDK_ROOT/ANDROID_HOME not set"
            exit 1
          fi
          "$SDK_ROOT/build-tools/35.0.0/apksigner" verify --verbose "${{ steps.artifacts.outputs.apk_release }}"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: |
            ${{ steps.artifacts.outputs.apk_debug }}
            ${{ steps.artifacts.outputs.apk_release }}
          if-no-files-found: error

      - name: Generate release notes (changelogen)
        if: ${{ github.event_name == 'push' || (inputs.release && inputs.create_tag && !inputs.dry_run) }}
        shell: bash
        env:
          TAG: ${{ needs.version.outputs.tag }}
        run: |
          set -euo pipefail

          git fetch --tags --force
          PREV_TAG=$(git tag -l 'v*.*.*' --sort=-v:refname | grep -v "^$TAG$" | head -n 1 || true)

          args=(--to "$TAG" --output release_notes.md)
          if [[ -n "$PREV_TAG" ]]; then
            args=(--from "$PREV_TAG" "${args[@]}")
          fi

          npx --yes changelogen@latest "${args[@]}"
          echo "Generated release_notes.md"

      - name: Create GitHub Release
        if: ${{ github.event_name == 'push' || (inputs.release && inputs.create_tag && !inputs.dry_run) }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: ${{ needs.version.outputs.tag }}
          body_path: release_notes.md
          files: |
            ${{ steps.artifacts.outputs.apk_debug }}
            ${{ steps.artifacts.outputs.apk_release }}
